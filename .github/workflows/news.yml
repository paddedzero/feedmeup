name: 'Weekly News Brief - Phase 1-2 (Gemini Synthesis + Dual-Post Output)'

on:
  schedule:
    - cron: '0 8 * * MON'  # Every Monday at 08:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Ruby for Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2
          bundler-cache: true

      - name: Install Ruby dependencies
        run: bundle install

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Run fetch_news.py to generate markdown posts
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python fetch_news.py

      - name: Build site with Jekyll
        run: bundle exec jekyll build

      - name: Remove conflicting custom styles to allow Chirpy theme CSS to load
        run: |
          # Remove custom CSS that overrides Chirpy theme
          rm -f assets/css/style.css || true
          echo "Removed custom style.css to use Chirpy theme CSS"

      - name: Deploy to gh-pages branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Clean up any stray Gemfile.lock and untracked files before branch switching
          rm -f Gemfile.lock || true
          git clean -fd || true
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Fetch gh-pages branch
          git fetch origin gh-pages || true
          
          # Switch to gh-pages, rebasing on remote (not creating orphan)
          git checkout -B gh-pages origin/gh-pages || git checkout --orphan gh-pages
          
          # Save existing posts before cleaning
          mkdir -p /tmp/posts_backup
          if [ -d "_posts" ]; then
            cp -r _posts /tmp/posts_backup/ || true
          fi
          
          # Remove build artifacts but preserve .git and _posts
          rm -rf _site .jekyll-cache .jekyll-metadata index.html assets/js assets/css 404.html || true
          
          # Restore posts
          if [ -d "/tmp/posts_backup/_posts" ]; then
            cp -r /tmp/posts_backup/_posts .
          fi
          
          # Copy built site contents to root (this is the pre-built HTML from Jekyll 4.4)
          if [ -d "_site" ]; then
            # Copy only HTML, images, and data files, NOT the _posts
            cp -r _site/* . || true
            rm -rf _site
          fi
          
          # Create .nojekyll to tell GitHub Pages NOT to rebuild (we've pre-built with Jekyll 4.4)
          touch .nojekyll
          
          # Stage all changes
          git add -A
          
          # Commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "publish: Jekyll build $(date +%Y-%m-%d\ %H:%M:%S)"
            git push -u origin gh-pages
          else
            echo "No changes to deploy"
          fi