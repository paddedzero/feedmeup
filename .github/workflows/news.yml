name: 'Weekly News Brief - Phase 1-2 (Gemini Synthesis + Dual-Post Output)'

on:
  schedule:
    - cron: '0 8 * * MON'  # Every Monday at 08:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Ruby for Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2
          bundler-cache: true

      - name: Install Ruby dependencies
        run: bundle install

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Run fetch_news.py to generate markdown posts
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python fetch_news.py

      - name: Build site with Jekyll
        run: bundle exec jekyll build

      - name: Remove conflicting custom styles to allow Chirpy theme CSS to load
        run: |
          # Remove custom CSS that overrides Chirpy theme
          rm -f assets/css/style.css || true
          echo "Removed custom style.css to use Chirpy theme CSS"

      - name: "ðŸ”µ BLUE: Verify user content integrity before deployment"
        run: |
          echo "Checking that all user content is present..."
          bash scripts/verify-content-safety.sh
          echo "âœ… User content verified - safe to proceed with deployment"

      - name: "ðŸŸ¢ GREEN: Build and test in staging area"
        run: |
          # Create a staging directory to test the build
          mkdir -p /tmp/staging
          cp -r ./_site/* /tmp/staging/ 2>/dev/null || true
          
          # Verify critical files exist in staging
          if [ ! -f "/tmp/staging/index.html" ]; then
            echo "âŒ ERROR: index.html not built in staging!"
            exit 1
          fi
          
          if [ ! -f "/tmp/staging/feed.xml" ]; then
            echo "âš ï¸  WARNING: feed.xml not found in staging"
          fi
          
          echo "âœ… Staging build validated - ready for production deployment"
          ls -lh /tmp/staging/index.html /tmp/staging/feed.xml 2>/dev/null || true

      - name: Deploy to gh-pages branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # BLUE-GREEN DEPLOYMENT
          # 1. Prepare "green" (new) environment
          # 2. Test it completely
          # 3. Only then remove "blue" (old) and promote green
          
          # Clean up any stray Gemfile.lock and untracked files before branch switching
          rm -f Gemfile.lock || true
          git clean -fd || true
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Fetch gh-pages branch (current production)
          git fetch origin gh-pages || true
          
          # Switch to gh-pages, rebasing on remote
          git checkout -B gh-pages origin/gh-pages || git checkout --orphan gh-pages
          
          # ===== BACKUP PHASE (BLUE) =====
          echo "ðŸ“¦ Backing up current production..."
          BACKUP_TIME=$(date +%s)
          mkdir -p /tmp/blue_backup_$BACKUP_TIME
          cp -r . /tmp/blue_backup_$BACKUP_TIME/ || true
          echo "âœ… Production backed up to: /tmp/blue_backup_$BACKUP_TIME"
          
          # ===== PREPARE GREEN DEPLOYMENT =====
          echo "ðŸŸ¢ Preparing green deployment..."
          
          # Save existing posts (ALWAYS backup user content)
          mkdir -p /tmp/posts_backup
          if [ -d "_posts" ]; then
            cp -r _posts /tmp/posts_backup/ || true
          fi
          POSTS_BEFORE=$(find _posts -name "*.md" 2>/dev/null | wc -l || echo 0)
          echo "Posts before deployment: $POSTS_BEFORE"
          
          # Remove build artifacts ONLY (keep user content)
          rm -rf .github .jekyll-cache .jekyll-metadata _site fetch_news.py config.yaml requirements.txt || true
          rm -f CHIRPY_THEME_IMPLEMENTATION.md CHIRPY_V7.4.1_UPDATE.md CRITICAL_SAFETY_RULES.md || true
          rm -f IMPLEMENTATION_EVALUATION.md MAIN_BRANCH_VERIFICATION.md THEME_FIX_DIAGNOSTIC.md || true
          rm -f THEME_RENDERING_FIX.md 404.md index.md Gemfile .gitignore tests/ 2>/dev/null || true
          
          # Restore posts from backup
          if [ -d "/tmp/posts_backup/_posts" ]; then
            cp -r /tmp/posts_backup/_posts .
          fi
          
          # Copy built site contents from _site to root
          if [ -d "_site" ]; then
            cp -r _site/* . || true
            rm -rf _site
          fi
          
          # Create .nojekyll to prevent GitHub Pages rebuild
          touch .nojekyll
          
          # ===== TEST GREEN DEPLOYMENT =====
          echo "ðŸ§ª Testing green deployment..."
          
          # Verify critical files exist
          if [ ! -f "index.html" ]; then
            echo "âŒ CRITICAL: index.html missing in green deployment!"
            echo "Rolling back to blue (production)..."
            cp -r /tmp/blue_backup_$BACKUP_TIME/* . || true
            git add -A
            git commit -m "rollback: Green deployment failed - index.html missing" || true
            git push -u origin gh-pages
            exit 1
          fi
          
          # Verify feed.xml
          if [ ! -f "feed.xml" ]; then
            echo "âš ï¸  WARNING: feed.xml missing (non-critical)"
          fi
          
          # Verify posts count didn't decrease
          POSTS_AFTER=$(find _posts -name "*.md" 2>/dev/null | wc -l || echo 0)
          echo "Posts after deployment: $POSTS_AFTER"
          if [ "$POSTS_AFTER" -lt "$POSTS_BEFORE" ]; then
            echo "âŒ CRITICAL: Posts were deleted! ($POSTS_BEFORE â†’ $POSTS_AFTER)"
            echo "Rolling back to blue..."
            cp -r /tmp/blue_backup_$BACKUP_TIME/* . || true
            git add -A
            git commit -m "rollback: Post count decreased" || true
            git push -u origin gh-pages
            exit 1
          fi
          
          echo "âœ… Green deployment validated"
          
          # ===== PROMOTE GREEN (remove old blue) =====
          echo "ðŸŸ¢ Promoting green to production..."
          
          # Stage all changes
          git add -A
          
          # Commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "publish: Jekyll build $(date +%Y-%m-%d\ %H:%M:%S) - blue-green deployment verified"
            git push -u origin gh-pages
            echo "âœ… Green promoted to production"
            echo "ðŸ“Š Deployment stats: Posts=$POSTS_AFTER, Timestamp=$(date)"
          else
            echo "â„¹ï¸  No changes to deploy"
          fi
          
          # Cleanup old backups (keep only last 3)
          echo "ðŸ§¹ Cleaning up old backups..."
          ls -1d /tmp/blue_backup_* 2>/dev/null | sort -r | tail -n +4 | xargs rm -rf 2>/dev/null || true